<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risultati Verifiche</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 10px;
            text-align: center;
        }
        table {
            margin-top: 20px;
            width: 100%;
        }
        th, td {
            width: auto;
        }
        .red {
            color: red;
        }
        .editable {
            cursor: pointer;
        }
        .grade-red {
            color: red;
            font-weight: bold;
        }
        .grade-black {
            color: black;
            font-weight: bold;
        }
        .grade-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ccc;
            padding: 5px;
            box-sizing: border-box;
            outline: none;
        }
    </style>
</head>
<body>
    <h1>Gestione Verifiche</h1>

    <!-- Selezione della classe -->
    <label for="classSelect">Seleziona la classe:</label>
    <select id="classSelect">
        <option value="">-- Seleziona una classe --</option>
        <option value="3 media">3 media</option>
        <option value="1 superiore">1 superiore</option>
    </select>

    <!-- Selezione della materia -->
    <div id="subjectSection" style="display:none;">
        <h3>Seleziona la materia:</h3>
        <select id="subjectSelect">
            <option value="Italiano">Italiano</option>
            <option value="Matematica">Matematica</option>
            <option value="Scienze">Scienze</option>
            <option value="Geografia">Geografia</option>
            <option value="Storia">Storia</option>
            <option value="Ginnastica">Ginnastica</option>
            <option value="Arte">Arte</option>
            <option value="Disegno">Disegno</option>
            <option value="Informatica">Informatica</option>
            <option value="Musica">Musica</option>
        </select>

        <br><br>

        <label for="testDate">Data della verifica:</label>
        <input type="date" id="testDate">
        <br><br>

        <button id="createTestBtn">Crea Verifica</button>
    </div>

    <!-- Tabella studenti -->
    <table id="studentsTable" style="display:none;">
        <thead>
            <tr id="tableHeader">
                <th>Studente</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        // Dati per le classi
        const students = {
            '3 media': [
                "Stellina Dematteis", "Tartaruga Dematteis", "Yucky Benua", "Lollo Benua", "Leonard Benua",
                "Sparcky Benua", "Flaffy Dematteis", "Tina Dematteis", "Grigetta Benua", "Luna Dematteis",
                "Luna Benua", "Kendy Dematteis", "Papero Benua", "Curt Dematteis", "Briciola Dematteis", 
                "Lampo Benua", "Sunny Benua", "Attiglio Dematteis"
            ],
            '1 superiore': [
                "Cane Dematteis", "Cane Benua", "Mician Dematteis", "Cicciobello Allabue", "Micheal Temperini",
                "Cattivo Temperini", "Bambola Rossetti", "Teschio Carottini", "Robottina Carottini"
            ]
        };

        const classSelect = document.getElementById('classSelect');
        const subjectSection = document.getElementById('subjectSection');
        const studentsTable = document.getElementById('studentsTable');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const createTestBtn = document.getElementById('createTestBtn');

        let currentClass = '';
        let tests = JSON.parse(localStorage.getItem('tests')) || {}; // Salva verifiche

        // Quando selezioni una classe
        classSelect.addEventListener('change', function() {
            const selectedClass = classSelect.value;
            if (selectedClass) {
                subjectSection.style.display = 'block'; // Mostra la sezione per scegliere le materie
                studentsTable.style.display = 'table';  // Mostra la tabella degli studenti
                loadStudents(selectedClass);
                currentClass = selectedClass;
            } else {
                subjectSection.style.display = 'none';
                studentsTable.style.display = 'none';
            }
        });

        // Carica gli studenti e le verifiche per la classe selezionata
        function loadStudents(className) {
            tableBody.innerHTML = ''; // Pulisce la tabella
            tableHeader.innerHTML = '<th>Studente</th>'; // Reset del header della tabella

            // Crea righe per gli studenti
            students[className].forEach(student => {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.textContent = student;
                row.appendChild(cell);
                tableBody.appendChild(row);

                // Aggiungi il voto se esiste già per questo studente
                if (tests[className]) {
                    tests[className].forEach(test => {
                        const grades = test.grades || {};
                        const grade = grades[student];
                        const gradeCell = document.createElement('td');
                        if (grade !== undefined) {
                            gradeCell.textContent = grade;
                            if (grade >= 10 && grade <= 59) {
                                gradeCell.classList.add('grade-red');
                            } else if (grade >= 60 && grade <= 100) {
                                gradeCell.classList.add('grade-black');
                            }
                        } else {
                            gradeCell.textContent = '-';
                        }
                        gradeCell.classList.add('editable'); // Aggiungi la classe per rendere la cella modificabile
                        gradeCell.addEventListener('click', function() {
                            enableEditMode(gradeCell, grade);
                        });
                        row.appendChild(gradeCell);
                    });
                }
            });

            // Carica le verifiche precedenti (se esistono)
            if (tests[className]) {
                tests[className].forEach(test => {
                    addTestColumn(test.date, test.subject, test.grades);
                });
            }
        }

        // Aggiungi una colonna per la verifica
        function addTestColumn(date, subject, grades) {
            // Aggiunge la data e la materia nel header
            const headerCell = document.createElement('th');
            headerCell.textContent = `${date} - ${subject}`;
            tableHeader.appendChild(headerCell);

            // Aggiunge una cella per ogni studente
            Array.from(tableBody.children).forEach(row => {
                const cell = document.createElement('td');
                const studentName = row.firstElementChild.textContent;
                if (grades && grades[studentName] !== undefined) {
                    cell.textContent = grades[studentName];
                    if (grades[studentName] >= 10 && grades[studentName] <= 59) {
                        cell.classList.add('grade-red');
                    } else if (grades[studentName] >= 60 && grades[studentName] <= 100) {
                        cell.classList.add('grade-black');
                    }
                } else {
                    cell.textContent = '-';
                }
                cell.classList.add('editable'); // Aggiungi la classe per rendere la cella modificabile
                cell.addEventListener('click', function() {
                    enableEditMode(cell, grades ? grades[studentName] : undefined);
                });
                row.appendChild(cell);
            });
        }

        // Abilita la modalità di modifica della cella
        function enableEditMode(cell, currentGrade) {
            const input = document.createElement('input');
            input.type = 'text';
            input.classList.add('grade-input');
            input.value = currentGrade !== undefined ? currentGrade : '';
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    disableEditMode(cell, input.value);
                }
            });
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
        }

        // Disabilita la modalità di modifica della cella
        function disableEditMode(cell, newGrade) {
            const studentName = cell.parentNode.firstElementChild.textContent;
            const className = classSelect.value;
            cell.textContent = newGrade;

            // Aggiorna il localStorage
            if (!tests[className]) {
                tests[className] = [];
            }
            const columnIndex = Array.from(cell.parentNode.children).indexOf(cell);
            const testIndex = columnIndex - 1; // -1 perché escludiamo la prima colonna (nome studente)
            if (!tests[className][testIndex].grades) {
                tests[className][testIndex].grades = {};
            }
            tests[className][testIndex].grades[studentName] = newGrade;
            localStorage.setItem('tests', JSON.stringify(tests));

            // Aggiungi la classe appropriata in base al nuovo voto inserito
            if (!isNaN(newGrade)) {
                newGrade = parseFloat(newGrade);
                if (newGrade >= 10 && newGrade <= 59) {
                    cell.classList.remove('grade-black');
                    cell.classList.add('grade-red');
                } else if (newGrade >= 60 && newGrade <= 100) {
                    cell.classList.remove('grade-red');
                    cell.classList.add('grade-black');
                }
            } else {
                alert("Inserisci un valore numerico valido.");
                cell.textContent = '-';
            }
        }

        // Quando si clicca "Crea Verifica"
        createTestBtn.addEventListener('click', function() {
            const subject = document.getElementById('subjectSelect').value;
            const date = document.getElementById('testDate').value;

            if (subject && date) {
                addTestColumn(date, subject, {});

                // Salva la verifica nel localStorage
                if (!tests[currentClass]) {
                    tests[currentClass] = [];
                }
                tests[currentClass].push({ date, subject, grades: {} });
                localStorage.setItem('tests', JSON.stringify(tests));
            }
        });

        // Carica le verifiche salvate al caricamento della pagina
        document.addEventListener('DOMContentLoaded', function () {
            const selectedClass = localStorage.getItem('selectedClass');
            if (selectedClass) {
                classSelect.value = selectedClass;
                classSelect.dispatchEvent(new Event('change')); // Trigger cambio classe
            }
        });

        // Salva la classe selezionata
        classSelect.addEventListener('change', function () {
            localStorage.setItem('selectedClass', classSelect.value);
        });
    </script>
</body>
</html>
