<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vita Scolastica</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 10px;
            text-align: center;
        }
        th, td {
            width: auto;
        }
        .status {
            cursor: pointer;
        }
        .status.present {
            background-color: lightgreen;
        }
        .status.absent {
            background-color: lightcoral;
        }
        .status.late {
            background-color: yellow;
        }
        .count {
            font-size: 0.8em;
            color: gray;
        }
    </style>
</head>
<body>
    <h1>Vita Scolastica - Registro Presenze</h1>

    <!-- Seleziona la classe -->
    <label for="classSelect">Seleziona la classe:</label>
    <select id="classSelect">
        <option value="">-- Seleziona una classe --</option>
        <option value="3 media">3 media</option>
        <option value="1 superiore">1 superiore</option>
    </select>

    <!-- Tabella studenti -->
    <table id="studentsTable" style="margin-top: 20px; display: none;">
        <thead>
            <tr>
                <th>Studente</th>
                <th>Presente <span id="presentTotal" class="count">(0)</span></th>
                <th>Assente <span id="absentTotal" class="count">(0)</span></th>
                <th>Ritardo <span id="lateTotal" class="count">(0)</span></th>
                <th>Presenze Totali</th>
                <th>Assenze Totali</th>
                <th>Ritardi Totali</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script>
        const students = {
            '3 media': [
                "Stellina Dematteis", "Tartaruga Dematteis", "Yucky Benua", "Lollo Benua", "Leonard Benua",
                "Sparcky Benua", "Flaffy Dematteis", "Tina Dematteis", "Grigetta Benua", "Luna Dematteis",
                "Luna Benua", "Kendy Dematteis", "Papero Benua", "Curt Dematteis", "Briciola Dematteis", 
                "Lampo Benua", "Sunny Benua", "Attiglio Dematteis"
            ],
            '1 superiore': [
                "Cane Dematteis", "Cane Benua", "Mician Dematteis", "Cicciobello Allabue", "Micheal Temperini", 
            "Cattivo Temperini", "Bambola Rossetti", "Teschio Carottini", "Robottina Carottini"
            ]
        };

        const classSelect = document.getElementById('classSelect');
        const studentsTable = document.getElementById('studentsTable');
        const tableBody = document.getElementById('tableBody');
        const presentTotal = document.getElementById('presentTotal');
        const absentTotal = document.getElementById('absentTotal');
        const lateTotal = document.getElementById('lateTotal');

        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {}; // Dati salvati

        // Quando si seleziona una classe
        classSelect.addEventListener('change', function() {
            const selectedClass = classSelect.value;
            if (selectedClass && students[selectedClass]) { // Controlla se la classe è valida
                loadStudents(selectedClass);
                studentsTable.style.display = 'table'; // Mostra la tabella se la classe esiste
            } else {
                studentsTable.style.display = 'none';
            }
        });

        // Carica gli studenti nella tabella
        function loadStudents(className) {
            tableBody.innerHTML = ''; // Pulisce la tabella

            students[className].forEach(student => {
                const row = document.createElement('tr');

                const studentCell = document.createElement('td');
                studentCell.textContent = student;
                row.appendChild(studentCell);

                // Colonna Presente
                const presentCell = createStatusCell('present', className, student);
                row.appendChild(presentCell);

                // Colonna Assente
                const absentCell = createStatusCell('absent', className, student);
                row.appendChild(absentCell);

                // Colonna Ritardo
                const lateCell = createStatusCell('late', className, student);
                row.appendChild(lateCell);

                // Colonna Presenze Totali
                const totalPresentCell = document.createElement('td');
                totalPresentCell.textContent = countTotal('present', student);
                row.appendChild(totalPresentCell);

                // Colonna Assenze Totali
                const totalAbsentCell = document.createElement('td');
                totalAbsentCell.textContent = countTotal('absent', student);
                row.appendChild(totalAbsentCell);

                // Colonna Ritardi Totali
                const totalLateCell = document.createElement('td');
                totalLateCell.textContent = countTotal('late', student);
                row.appendChild(totalLateCell);

                tableBody.appendChild(row);

                // Aggiorna lo stato visibile iniziale
                updateVisibleStatus(student, className);
            });
        }

        // Crea una cella con lo stato (presente, assente, ritardo)
        function createStatusCell(statusType, className, student) {
            const cell = document.createElement('td');
            cell.classList.add('status', statusType);

            // Controlla se c'è uno stato già salvato
            const savedStatus = attendanceData[className]?.[student];
            if (savedStatus === statusType) {
                cell.style.backgroundColor = getStatusColor(statusType);
            }

            // Al click, cambia lo stato
            cell.addEventListener('click', function() {
                updateStatus(className, student, statusType);
                updateVisibleStatus(student, className); // Aggiorna lo stato visibile
            });

            return cell;
        }

        // Aggiorna lo stato dell'alunno
        function updateStatus(className, student, statusType) {
            // Cancellare eventuali stati precedenti
            if (!attendanceData[className]) attendanceData[className] = {};
            delete attendanceData[className][student];

            // Imposta il nuovo stato
            attendanceData[className][student] = statusType;
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));

            // Aggiorna i totali nella riga dello studente
            const row = Array.from(tableBody.children).find(r => r.firstChild.textContent === student);
            if (row) {
                row.children[4].textContent = countTotal('present', student);
                row.children[5].textContent = countTotal('absent', student);
                row.children[6].textContent = countTotal('late', student);
            }

            // Aggiorna i totali complessivi
            updateTotals();
        }

        // Aggiorna i totali complessivi (presenze, assenze, ritardi)
        function updateTotals() {
            let totalPresent = 0;
            let totalAbsent = 0;
            let totalLate = 0;

            Object.keys(attendanceData).forEach(className => {
                Object.values(attendanceData[className]).forEach(status => {
                    if (status === 'present') totalPresent++;
                    if (status === 'absent') totalAbsent++;
                    if (status === 'late') totalLate++;
                });
            });

            presentTotal.textContent = `(${totalPresent})`;
            absentTotal.textContent = `(${totalAbsent})`;
            lateTotal.textContent = `(${totalLate})`;
        }

        // Carica la classe salvata
        document.addEventListener('DOMContentLoaded', function () {
            const savedClass = localStorage.getItem('selectedClass');
            if (savedClass) {
                classSelect.value = savedClass;
                classSelect.dispatchEvent(new Event('change'));
            }
        });

        // Salva la classe selezionata
        classSelect.addEventListener('change', function () {
            localStorage.setItem('selectedClass', classSelect.value);
        });
    </script>
</body>
</html>
